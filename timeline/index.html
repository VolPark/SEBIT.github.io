<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responzivní Generátor Roadmapy s AI a Firebase</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Knihovny pro export a Drag&Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        /* Skrytí ovládacích prvků a úprava layoutu při exportu */
        .exporting .no-export { display: none !important; }
        .exporting #roadmap-container {
            overflow: visible !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto !important;
        }

        /* Animace a přechody */
        .roadmap-item, .phase-column { transition: all 0.3s ease-in-out; }
        .sortable-ghost {
            opacity: 0.4;
            background: #c7d2fe; /* indigo-200 */
        }
        .sortable-drag {
            opacity: 1 !important;
        }

        /* Tlačítko pro potvrzení smazání */
        .btn-confirm-delete {
            background-color: #dc2626 !important; /* red-600 */
        }
        .btn-confirm-delete:hover {
            background-color: #b91c1c !important; /* red-700 */
        }
        
        /* Loading overlay */
        #loading-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .spinner, .spinner-small {
            border-color: #4f46e5; /* indigo-600 */
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        .spinner { width: 4rem; height: 4rem; }
        .spinner-small { width: 1rem; height: 1rem; display: inline-block; margin-left: 0.5rem; }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobilní sidebar */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-open #sidebar {
            transform: translateX(0);
        }
        .sidebar-open #sidebar-overlay {
            display: block;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="flex h-screen">
        <!-- LEVÝ OVLÁDÁCÍ PANEL (SIDEBAR) -->
        <aside id="sidebar" class="w-80 md:w-96 bg-white p-6 shadow-lg overflow-y-auto no-export flex-shrink-0 fixed md:relative inset-y-0 left-0 z-30 transform -translate-x-full md:translate-x-0">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <span id="logo-placeholder" class="text-blue-600 mr-3"></span>
                    <h1 class="text-2xl font-bold text-slate-900">Roadmapa</h1>
                </div>
                <button id="close-sidebar-btn" class="md:hidden text-slate-500 hover:text-slate-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>

            <!-- PŘEPÍNAČ ZOBRAZENÍ -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-3 text-slate-700">Zobrazení</h2>
                <div class="flex rounded-lg bg-slate-100 p-1">
                    <button id="btn-horizontal" class="w-1/2 py-2 text-sm font-medium rounded-md transition-colors">Horizontální</button>
                    <button id="btn-vertical" class="w-1/2 py-2 text-sm font-medium rounded-md transition-colors">Vertikální</button>
                </div>
            </div>
            
            <!-- FILTRY -->
            <div id="filters" class="mb-6">
                <h2 class="text-lg font-semibold mb-3 text-slate-700">Filtry</h2>
                <div class="space-y-4">
                     <div>
                        <label for="filter-status" class="block text-sm font-medium text-slate-600 mb-1">Stav</label>
                        <select id="filter-status" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="all">Všechny</option>
                            <option value="todo">Čeká</option>
                            <option value="inprogress">Probíhá</option>
                            <option value="done">Hotovo</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-priority" class="block text-sm font-medium text-slate-600 mb-1">Priorita</label>
                        <select id="filter-priority" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="all">Všechny</option>
                            <option value="low">Nízká</option>
                            <option value="medium">Střední</option>
                            <option value="high">Vysoká</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- FORMULÁŘ PRO PŘIDÁNÍ ÚKOLU -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-3 text-slate-700">Přidat nový úkol</h2>
                <form id="add-item-form" class="space-y-4">
                    <input type="text" id="item-title" placeholder="Název úkolu" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                    <div class="relative">
                        <textarea id="item-desc" placeholder="Popis (nebo vygenerujte s AI ✨)" rows="2" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                        <button type="button" id="btn-ai-generate-desc" class="absolute bottom-2 right-2 p-1.5 rounded-md bg-indigo-100 text-indigo-600 hover:bg-indigo-200" title="Vygenerovat popis (AI)">✨</button>
                    </div>
                    <select id="item-phase" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></select>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="item-priority" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="medium">Střední priorita</option>
                            <option value="low">Nízká priorita</option>
                            <option value="high">Vysoká priorita</option>
                        </select>
                        <select id="item-status" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="todo">Čeká</option>
                            <option value="inprogress">Probíhá</option>
                            <option value="done">Hotovo</option>
                        </select>
                    </div>
                    <input type="color" id="item-color" value="#3b82f6" class="w-full h-10 p-1 border border-slate-300 rounded-lg cursor-pointer">
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <span id="plus-icon" class="mr-2"></span>
                        Přidat úkol
                    </button>
                </form>
            </div>

            <!-- SPRÁVA FÁZÍ -->
            <div id="phase-management" class="mb-6">
                <h2 class="text-lg font-semibold mb-3 text-slate-700">Spravovat fáze</h2>
                <div class="flex space-x-2">
                    <input type="text" id="phase-name" placeholder="Název nové fáze" class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <button id="btn-add-phase" aria-label="Přidat novou fázi" class="bg-slate-200 text-slate-800 font-semibold p-2 rounded-lg hover:bg-slate-300 transition-colors flex items-center justify-center">
                       <span id="plus-icon-phase"></span>
                    </button>
                </div>
            </div>

            <!-- EXPORT -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-3 text-slate-700">Exportovat</h2>
                <div class="space-y-3">
                    <button id="btn-export-png" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                        <span id="image-icon" class="mr-2"></span>
                        Uložit jako PNG
                    </button>
                    <button id="btn-export-pdf" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center">
                        <span id="file-text-icon" class="mr-2"></span>
                        Uložit jako PDF
                    </button>
                    <!-- Přidejte do sekce Exportovat -->
                    <button id="btn-export-json" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                        <span class="mr-2">⬇️</span>
                        Uložit jako JSON
                    </button>
                    <button id="btn-import-json" class="w-full bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-600 transition-colors flex items-center justify-center">
                        <span class="mr-2">⬆️</span>
                        Načíst z JSON
                    </button>
                    <input type="file" id="import-json-input" accept=".json" class="hidden" />
                </div>
            </div>
            
            <div class="text-xs text-slate-400 mt-auto text-center">
                <p>Kliknutím na úkol/fázi je upravíte. Úkoly můžete přetahovat.</p>
            </div>
        </aside>
        
        <!-- Overlay pro mobilní sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <!-- OBLAST S ROADMAPOU -->
        <main class="flex-1 flex flex-col h-screen">
            <!-- Horní lišta s hamburger menu -->
            <header class="bg-white shadow-sm p-4 flex items-center md:hidden no-export">
                <button id="open-sidebar-btn" class="text-slate-600 hover:text-slate-900">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <h2 class="text-lg font-semibold ml-4">Roadmapa</h2>
            </header>
            
            <div class="flex-1 p-4 md:p-8 overflow-auto bg-slate-100 relative">
                <div id="roadmap-container" class="w-full h-full">
                    <!-- Obsah roadmapy se generuje dynamicky -->
                </div>
                <!-- Loading Overlay -->
                <div id="loading-overlay" class="absolute inset-0 bg-slate-100 bg-opacity-80 flex items-center justify-center no-export z-40">
                    <div class="text-center">
                        <div class="spinner border-4 rounded-full mx-auto"></div>
                        <p id="loading-text" class="text-lg font-semibold text-slate-700 mt-4">Připojuji k databázi...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- MODÁLNÍ OKNO PRO ÚPRAVY -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 no-export">
        <div class="bg-white rounded-lg p-8 shadow-2xl w-full max-w-md m-4">
            <h2 id="modal-title" class="text-xl font-bold mb-4">Upravit položku</h2>
            <div id="modal-body" class="space-y-4"></div>
            <div class="mt-6 flex justify-between items-center">
                <button id="modal-btn-delete" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Smazat</button>
                <div class="space-x-3">
                    <button id="modal-btn-cancel" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Zrušit</button>
                    <button id="modal-btn-save" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Uložit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HTML ŠABLONY -->
    <template id="roadmap-item-template">
        <div class="roadmap-item bg-white p-4 rounded-lg shadow-md border-l-4 cursor-grab hover:shadow-lg hover:-translate-y-1 transition-all">
            <div class="flex justify-between items-start">
                <h4 class="font-bold text-slate-900 pr-2"></h4>
                <div class="flex-shrink-0 space-x-2 text-right">
                    <span class="priority-badge inline-block px-2 py-0.5 text-xs font-medium rounded-full"></span>
                    <span class="status-badge inline-block px-2 py-0.5 text-xs font-medium rounded-full"></span>
                </div>
            </div>
            <p class="item-description text-sm text-slate-600 mt-1"></p>
        </div>
    </template>
    
    <template id="phase-column-template">
        <div class="phase-column bg-slate-100/50 rounded-lg p-4 flex flex-col shadow-sm">
            <div class="flex justify-between items-center mb-4 gap-2">
                <h3 class="phase-title font-bold text-lg text-slate-800 cursor-pointer p-2 -ml-2 rounded hover:bg-slate-200 flex-grow"></h3>
                <button class="btn-ai-suggest-tasks flex-shrink-0 p-2 rounded-lg bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition-colors" title="Navrhnout úkoly (AI)">
                    ✨
                </button>
            </div>
            <div class="items-container space-y-4 flex-grow min-h-[100px]"></div>
        </div>
    </template>

    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {

            // --- IKONY ---
            const icons = {
                map: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6v12"/><path d="M6 6v12"/><path d="M12 18V6"/><path d="M12 6H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h6"/><path d="M12 18h6a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-6"/></svg>',
                plus: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
                image: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',
                fileText: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>'
            };
            document.getElementById('logo-placeholder').innerHTML = icons.map;
            document.getElementById('plus-icon').innerHTML = icons.plus;
            document.getElementById('plus-icon-phase').innerHTML = icons.plus;
            document.getElementById('image-icon').innerHTML = icons.image;
            document.getElementById('file-text-icon').innerHTML = icons.fileText;

            // --- STAV APLIKACE ---
            let state;
            let db;
            let auth;
            let userId;
            let unsubscribeFromFirestore; // Pro odhlášení listeneru

            const defaultState = {
                layout: 'horizontal',
                filters: { status: 'all', priority: 'all' },
                phases: [
                    { id: 1, name: 'Výzkum a Analýza' },
                    { id: 2, name: 'Design a Prototypy' },
                    { id: 3, name: 'Vývoj a Testování' },
                    { id: 4, name: 'Spuštění a Marketing' }
                ],
                items: [
                    { id: 1, title: 'Analýza konkurence', description: 'Zmapování hlavních konkurentů na trhu.', phaseId: 1, color: '#3b82f6', priority: 'high', status: 'done' },
                    { id: 2, title: 'Uživatelské průzkumy', description: 'Dotazníky a rozhovory s cílovou skupinou.', phaseId: 1, color: '#3b82f6', priority: 'high', status: 'inprogress' },
                    { id: 3, title: 'Wireframy a Mockupy', description: 'Vytvoření základní struktury a vizuálního návrhu.', phaseId: 2, color: '#a855f7', priority: 'medium', status: 'todo' },
                ],
                nextItemId: 4,
                nextPhaseId: 5
            };

            // --- SELEKTORY DOM ELEMENTŮ ---
            const body = document.body;
            const openSidebarBtn = document.getElementById('open-sidebar-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const roadmapContainer = document.getElementById('roadmap-container');
            const addItemForm = document.getElementById('add-item-form');
            const btnGenerateDesc = document.getElementById('btn-ai-generate-desc');
            const btnHorizontal = document.getElementById('btn-horizontal');
            const btnVertical = document.getElementById('btn-vertical');
            const phaseManagementDiv = document.getElementById('phase-management');
            const btnAddPhase = document.getElementById('btn-add-phase');
            const btnExportPng = document.getElementById('btn-export-png');
            const btnExportPdf = document.getElementById('btn-export-pdf');
            const editModal = document.getElementById('edit-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalBtnSave = document.getElementById('modal-btn-save');
            const modalBtnCancel = document.getElementById('modal-btn-cancel');
            const modalBtnDelete = document.getElementById('modal-btn-delete');
            const filterStatus = document.getElementById('filter-status');
            const filterPriority = document.getElementById('filter-priority');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            let editingContext = null;

            // --- FIREBASE INTEGRACE ---
            async function initializeFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyC-FmJAtv9aNld-iHjtiwi2FVHjeDccT6w",
                    authDomain: "sebit-web-timeline.firebaseapp.com",
                    projectId: "sebit-web-timeline",
                    storageBucket: "sebit-web-timeline.appspot.com",
                    messagingSenderId: "972665408352",
                    appId: "1:972665408352:web:fc2eeb23ada54e2f76ec05"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        setupFirestoreListener(userId);
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Firebase sign-in failed:", error);
                            showLoading(true, "Chyba přihlášení. Povolte Anonymní přihlašování ve Firebase.");
                        }
                    }
                });
            }

            function setupFirestoreListener(uid) {
                const docRef = doc(db, "roadmaps", uid);
                
                if (unsubscribeFromFirestore) {
                    unsubscribeFromFirestore(); 
                }

                unsubscribeFromFirestore = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        state = docSnap.data();
                        if (!state.items) state.items = [];
                        if (!state.phases) state.phases = [];
                    } else {
                        state = JSON.parse(JSON.stringify(defaultState));
                        saveStateToFirestore(); 
                    }
                    showLoading(false);
                    render();
                }, (error) => {
                    console.error("Chyba při naslouchání databázi:", error);
                    showLoading(true, "Chyba spojení s databází.");
                });
            }
            
            async function saveStateToFirestore() {
                if (!userId || !state) return;
                try {
                    await setDoc(doc(db, "roadmaps", userId), state);
                } catch (error) {
                    console.error("Chyba při ukládání do Firestore:", error);
                    alert("Nepodařilo se uložit změny.");
                }
            }
            
            // --- POMOCNÉ FUNKCE PRO VZHLED ---
            const priorityMap = {
                low: { text: 'Nízká', classes: 'bg-blue-100 text-blue-800' },
                medium: { text: 'Střední', classes: 'bg-yellow-100 text-yellow-800' },
                high: { text: 'Vysoká', classes: 'bg-red-100 text-red-800' },
            };
            const statusMap = {
                todo: { text: 'Čeká', classes: 'bg-slate-200 text-slate-800' },
                inprogress: { text: 'Probíhá', classes: 'bg-orange-200 text-orange-800' },
                done: { text: 'Hotovo', classes: 'bg-green-200 text-green-800' },
            };

            // --- FUNKCE PRO VYKRESLOVÁNÍ ---
            const render = () => {
                if (!state) { 
                    showLoading(true, "Načítám data...");
                    return;
                }
                showLoading(false);
                updatePhaseSelect();
                updateLayoutButtons();
                roadmapContainer.innerHTML = '';
                
                const isMobile = window.innerWidth < 768;

                if (state.layout === 'horizontal') {
                    renderHorizontalRoadmap();
                    phaseManagementDiv.style.display = 'block';
                    document.getElementById('filters').style.display = 'block';
                } else {
                    renderVerticalRoadmap(isMobile);
                    phaseManagementDiv.style.display = 'none';
                    document.getElementById('filters').style.display = 'none';
                }
            };

            const updatePhaseSelect = () => {
                if (state && state.phases) {
                    document.getElementById('item-phase').innerHTML = state.phases.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                }
            };
            
            const updateLayoutButtons = () => {
                const isHorizontal = state.layout === 'horizontal';
                btnHorizontal.classList.toggle('bg-white', isHorizontal);
                btnHorizontal.classList.toggle('text-blue-600', isHorizontal);
                btnHorizontal.classList.toggle('shadow', isHorizontal);
                btnHorizontal.classList.toggle('bg-transparent', !isHorizontal);
                btnHorizontal.classList.toggle('text-slate-600', !isHorizontal);
                btnVertical.classList.toggle('bg-white', !isHorizontal);
                btnVertical.classList.toggle('text-blue-600', !isHorizontal);
                btnVertical.classList.toggle('shadow', !isHorizontal);
                btnVertical.classList.toggle('bg-transparent', isHorizontal);
                btnVertical.classList.toggle('text-slate-600', isHorizontal);
            };

            const getFilteredItems = () => {
                if (!state || !state.items) return [];
                return state.items.filter(item => 
                    (state.filters.status === 'all' || item.status === state.filters.status) &&
                    (state.filters.priority === 'all' || item.priority === state.filters.priority)
                );
            }

            const renderHorizontalRoadmap = () => {
                roadmapContainer.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 md:gap-6';

                if (state.phases.length === 0) {
                    roadmapContainer.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-slate-500">Žádné fáze nebyly vytvořeny.</h3><p class="text-slate-400 mt-2">Začněte přidáním nové fáze v levém panelu.</p></div>`;
                    return;
                }
                
                const filteredItems = getFilteredItems();
                state.phases.forEach(phase => {
                    const phaseCol = createPhaseColumnElement(phase);
                    const itemsContainer = phaseCol.querySelector('.items-container');
                    const phaseItems = filteredItems.filter(item => item.phaseId === phase.id);
                    
                    if(phaseItems.length > 0) {
                        phaseItems.forEach(item => itemsContainer.appendChild(createRoadmapItemElement(item)));
                    } else {
                        itemsContainer.innerHTML = `<div class="text-center text-sm text-slate-400 p-4 border-2 border-dashed rounded-lg">Žádné úkoly</div>`;
                    }
                    
                    roadmapContainer.appendChild(phaseCol);
                    new Sortable(itemsContainer, { group: 'roadmap-items', animation: 150, ghostClass: 'sortable-ghost', onEnd: (evt) => {
                        const item = state.items.find(i => i.id === parseInt(evt.item.dataset.id));
                        if (item) {
                            item.phaseId = parseInt(evt.to.closest('.phase-column').dataset.id);
                            saveStateToFirestore();
                        }
                    }});
                });
            };

            const renderVerticalRoadmap = (isMobile) => {
                roadmapContainer.className = 'relative flex flex-col items-center pt-8';
                const items = state.items;

                if (!items || items.length === 0) {
                    roadmapContainer.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-slate-500">Žádné úkoly k zobrazení.</h3></div>`;
                    return;
                }
                
                const timelineLine = document.createElement('div');
                timelineLine.className = `absolute top-0 w-1 bg-slate-300 h-full ${isMobile ? 'left-4' : 'left-1/2 -translate-x-1/2'}`;
                roadmapContainer.appendChild(timelineLine);

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'w-full max-w-4xl space-y-8';
                
                items.forEach((item, index) => {
                    const side = index % 2 === 0 ? 'left' : 'right';
                    const itemWrapper = document.createElement('div');
                    itemWrapper.className = `relative w-full flex ${!isMobile && side === 'left' ? 'justify-start' : 'justify-end'}`;
                    
                    const itemContainer = document.createElement('div');
                    itemContainer.className = isMobile ? 'w-full ml-10' : `w-1/2 px-8 ${side === 'left' ? 'pr-8' : 'pl-8'}`;
                    itemContainer.appendChild(createRoadmapItemElement(item));
                    itemWrapper.appendChild(itemContainer);
                    
                    const dot = document.createElement('div');
                    dot.className = `absolute top-1/2 w-4 h-4 rounded-full -translate-y-1/2 border-4 border-slate-100 ${isMobile ? 'left-4 -translate-x-1/2' : 'left-1/2 -translate-x-1/2'}`;
                    dot.style.backgroundColor = item.color;
                    itemWrapper.appendChild(dot);
                    
                    contentWrapper.appendChild(itemWrapper);
                });
                roadmapContainer.appendChild(contentWrapper);
            };

            const createRoadmapItemElement = (item) => {
                const template = document.getElementById('roadmap-item-template').content.cloneNode(true).firstElementChild;
                template.style.borderColor = item.color;
                template.dataset.id = item.id;
                template.dataset.type = 'item';
                template.querySelector('h4').textContent = item.title;
                const descEl = template.querySelector('.item-description');
                descEl.textContent = item.description || '';
                if (!item.description) descEl.classList.add('hidden');
                
                const priorityBadge = template.querySelector('.priority-badge');
                priorityBadge.textContent = priorityMap[item.priority]?.text || '';
                priorityBadge.className += ' ' + (priorityMap[item.priority]?.classes || '');

                const statusBadge = template.querySelector('.status-badge');
                statusBadge.textContent = statusMap[item.status]?.text || '';
                statusBadge.className += ' ' + (statusMap[item.status]?.classes || '');

                return template;
            };
            
            const createPhaseColumnElement = (phase) => {
                const template = document.getElementById('phase-column-template').content.cloneNode(true).firstElementChild;
                const phaseEl = template;
                phaseEl.dataset.id = phase.id;
                phaseEl.dataset.type = 'phase';
                const titleEl = phaseEl.querySelector('.phase-title');
                titleEl.textContent = phase.name;
                titleEl.dataset.id = phase.id;
                titleEl.dataset.type = 'phase';
                return phaseEl;
            };

            // --- EVENT LISTENERY ---
            
            // Sidebar toggle
            const toggleSidebar = () => body.classList.toggle('sidebar-open');
            openSidebarBtn.addEventListener('click', toggleSidebar);
            closeSidebarBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newItem = {
                    id: state.nextItemId++,
                    title: document.getElementById('item-title').value,
                    description: document.getElementById('item-desc').value,
                    phaseId: parseInt(document.getElementById('item-phase').value) || (state.phases[0]?.id || 0),
                    color: document.getElementById('item-color').value,
                    priority: document.getElementById('item-priority').value,
                    status: document.getElementById('item-status').value,
                };
                state.items.push(newItem);
                saveStateToFirestore();
                addItemForm.reset();
                document.getElementById('item-color').value = '#3b82f6';
            });

            btnAddPhase.addEventListener('click', () => {
                const name = document.getElementById('phase-name').value.trim();
                if (name) {
                    state.phases.push({ id: state.nextPhaseId++, name: name });
                    document.getElementById('phase-name').value = '';
                    saveStateToFirestore();
                }
            });
            
            roadmapContainer.addEventListener('click', (e) => {
                const clickableElement = e.target.closest('[data-type]');
                if (clickableElement) {
                    e.stopPropagation();
                    openEditModal(clickableElement.dataset.type, parseInt(clickableElement.dataset.id));
                }

                const suggestButton = e.target.closest('.btn-ai-suggest-tasks');
                if (suggestButton) {
                    e.stopPropagation();
                    const phaseId = parseInt(suggestButton.closest('.phase-column').dataset.id);
                    handleSuggestTasks(phaseId, suggestButton);
                }
            });

            btnHorizontal.addEventListener('click', () => switchLayout('horizontal'));
            btnVertical.addEventListener('click', () => switchLayout('vertical'));
            const switchLayout = (newLayout) => {
                if (state.layout !== newLayout) {
                    state.layout = newLayout;
                    saveStateToFirestore();
                }
            };
            
            filterStatus.addEventListener('change', (e) => { state.filters.status = e.target.value; render(); });
            filterPriority.addEventListener('change', (e) => { state.filters.priority = e.target.value; render(); });
            btnGenerateDesc.addEventListener('click', handleGenerateNewDescription);
            
            // --- MODÁLNÍ OKNO LOGIKA ---
            const openEditModal = (type, id) => {
                editingContext = { type, id };
                modalBody.innerHTML = '';
                
                if (type === 'item') {
                    const item = state.items.find(i => i.id === id);
                    modalTitle.textContent = 'Upravit úkol';
                    modalBody.innerHTML = `
                        <input type="text" id="edit-item-title" value="${item.title}" class="w-full p-2 border border-slate-300 rounded-lg">
                        <div class="relative">
                            <textarea id="edit-item-desc" rows="3" class="w-full p-2 border border-slate-300 rounded-lg">${item.description}</textarea>
                            <button id="btn-ai-improve-desc" class="absolute bottom-2 right-2 p-1.5 rounded-md bg-indigo-100 text-indigo-600 hover:bg-indigo-200" title="Vylepšit popis (AI)">✨</button>
                        </div>
                        <select id="edit-item-phase" class="w-full p-2 border border-slate-300 rounded-lg" ${state.layout === 'vertical' ? 'disabled' : ''}>
                            ${state.phases.map(p => `<option value="${p.id}" ${p.id === item.phaseId ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                        <div class="grid grid-cols-2 gap-4">
                            <select id="edit-item-priority" class="w-full p-2 border border-slate-300 rounded-lg">${Object.keys(priorityMap).map(p => `<option value="${p}" ${p === item.priority ? 'selected' : ''}>${priorityMap[p].text}</option>`).join('')}</select>
                            <select id="edit-item-status" class="w-full p-2 border border-slate-300 rounded-lg">${Object.keys(statusMap).map(s => `<option value="${s}" ${s === item.status ? 'selected' : ''}>${statusMap[s].text}</option>`).join('')}</select>
                        </div>
                        <input type="color" id="edit-item-color" value="${item.color}" class="w-full h-10 p-1 border border-slate-300 rounded-lg">
                    `;
                    document.getElementById('btn-ai-improve-desc').addEventListener('click', handleImproveDescription);

                } else if (type === 'phase') {
                    const phase = state.phases.find(p => p.id === id);
                    modalTitle.textContent = 'Upravit fázi';
                    modalBody.innerHTML = `<input type="text" id="edit-phase-name" value="${phase.name}" class="w-full p-2 border border-slate-300 rounded-lg">`;
                }
                editModal.classList.remove('hidden');
                editModal.classList.add('flex');
            };
            
            const closeEditModal = () => {
                editModal.classList.add('hidden');
                editModal.classList.remove('flex');
                editingContext = null;
                modalBtnDelete.classList.remove('btn-confirm-delete');
                modalBtnDelete.innerHTML = 'Smazat';
            };
            
            modalBtnCancel.addEventListener('click', closeEditModal);
            
            modalBtnSave.addEventListener('click', () => {
                if (!editingContext) return;
                const { type, id } = editingContext;
                
                if (type === 'item') {
                    const itemIndex = state.items.findIndex(i => i.id === id);
                    if (itemIndex > -1) {
                        state.items[itemIndex].title = document.getElementById('edit-item-title').value;
                        state.items[itemIndex].description = document.getElementById('edit-item-desc').value;
                        state.items[itemIndex].phaseId = parseInt(document.getElementById('edit-item-phase').value);
                        state.items[itemIndex].priority = document.getElementById('edit-item-priority').value;
                        state.items[itemIndex].status = document.getElementById('edit-item-status').value;
                        state.items[itemIndex].color = document.getElementById('edit-item-color').value;
                    }
                } else if (type === 'phase') {
                    const phaseIndex = state.phases.findIndex(p => p.id === id);
                    if (phaseIndex > -1) {
                        state.phases[phaseIndex].name = document.getElementById('edit-phase-name').value;
                    }
                }
                closeEditModal();
                saveStateToFirestore();
            });

            modalBtnDelete.addEventListener('click', () => {
                if (!editingContext) return;
                
                const { type, id } = editingContext;
                if (!modalBtnDelete.classList.contains('btn-confirm-delete')) {
                    modalBtnDelete.classList.add('btn-confirm-delete');
                    modalBtnDelete.innerHTML = `Potvrdit smazání`;
                    return;
                }

                if (type === 'item') {
                    state.items = state.items.filter(i => i.id !== id);
                } else if (type === 'phase') {
                    state.items = state.items.filter(i => i.phaseId !== id);
                    state.phases = state.phases.filter(p => p.id !== id);
                }
                closeEditModal();
                saveStateToFirestore();
            });

            // --- EXPORT LOGIKA ---
            const exportCanvas = (format) => {
                showLoading(true, 'Exportuji...');
                
                setTimeout(() => {
                    html2canvas(roadmapContainer, { scale: 2, backgroundColor: '#f8fafc', useCORS: true })
                    .then(canvas => {
                        if (format === 'png') {
                            const link = document.createElement('a');
                            link.download = 'roadmap.png';
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                        } else if (format === 'pdf') {
                            const { jsPDF } = window.jspdf;
                            const imgData = canvas.toDataURL('image/png');
                            const orientation = canvas.width > canvas.height ? 'l' : 'p';
                            const pdf = new jsPDF({ orientation, unit: 'mm', format: 'a4' });
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            const pdfHeight = pdf.internal.pageSize.getHeight();
                            const canvasAspectRatio = canvas.width / canvas.height;
                            let finalImgWidth = pdfWidth;
                            let finalImgHeight = pdfWidth / canvasAspectRatio;
                            if (finalImgHeight > pdfHeight) {
                                finalImgHeight = pdfHeight;
                                finalImgWidth = pdfHeight * canvasAspectRatio;
                            }
                            pdf.addImage(imgData, 'PNG', 0, 0, finalImgWidth, finalImgHeight);
                            pdf.save('roadmap.pdf');
                        }
                    }).catch(err => {
                        console.error("Chyba při exportu:", err);
                    }).finally(() => {
                        showLoading(false);
                    });
                }, 200);
            };

            btnExportPng.addEventListener('click', () => exportCanvas('png'));
            btnExportPdf.addEventListener('click', () => exportCanvas('pdf'));

            // ...existing code...

            // --- EXPORT/IMPORT JSON ---
            const btnExportJson = document.getElementById('btn-export-json');
            const btnImportJson = document.getElementById('btn-import-json');
            const importJsonInput = document.getElementById('import-json-input');

            btnExportJson.addEventListener('click', () => {
                if (!state) return;
                const dataStr = JSON.stringify(state, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'timeline.json';
                a.click();
                URL.revokeObjectURL(url);
            });

            btnImportJson.addEventListener('click', () => {
                importJsonInput.click();
            });

            importJsonInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        // Volitelně validujte strukturu importedState
                        state = importedState;
                        saveStateToFirestore();
                        render();
                        alert('Timeline byla úspěšně importována.');
                    } catch (err) {
                        alert('Chyba při načítání JSON souboru.');
                    }
                };
                reader.readAsText(file);
            });
            // ...existing code...

            // --- AI FUNKCE (GEMINI) ---
            const showLoading = (isLoading, text = 'Načítám...') => {
                loadingText.textContent = text;
                loadingOverlay.classList.toggle('hidden', !isLoading);
                loadingOverlay.classList.toggle('flex', isLoading);
            };

            async function callGemini(prompt) {
                const apiKey = "AIzaSyD8KytMlknhaCilHjfBk7dR8F13swM8Rv8"; // API klíč je spravován v prostředí Canvas
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Chyba API: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Neplatná odpověď od API.");
                    }
                } catch (error) {
                    console.error("Chyba při volání Gemini API:", error);
                    alert("Došlo k chybě při komunikaci s AI. Zkuste to prosím později.");
                    return null;
                }
            }

            async function handleSuggestTasks(phaseId, button) {
                const phase = state.phases.find(p => p.id === phaseId);
                if (!phase) return;

                const originalButtonContent = button.innerHTML;
                button.innerHTML = '<div class="spinner-small border-2"></div>';
                button.disabled = true;

                const prompt = `Jsi expert na projektové řízení. Pro fázi projektu nazvanou "${phase.name}" navrhni 3 až 5 klíčových úkolů. Odpověz pouze seznamem úkolů, kde každý úkol je na novém řádku, bez odrážek nebo čísel. Například:\nPrvní úkol\nDruhý úkol\nTřetí úkol`;
                
                const resultText = await callGemini(prompt);

                if (resultText) {
                    const tasks = resultText.split('\n').filter(t => t.trim() !== '');
                    tasks.forEach(taskTitle => {
                        state.items.push({
                            id: state.nextItemId++,
                            title: taskTitle.trim(),
                            description: '',
                            phaseId: phaseId,
                            color: '#8b5cf6', // Default AI color
                            priority: 'medium',
                            status: 'todo',
                        });
                    });
                    saveStateToFirestore();
                }

                button.innerHTML = originalButtonContent;
                button.disabled = false;
            }

            async function handleImproveDescription(event) {
                const button = event.target.closest('button');
                const title = document.getElementById('edit-item-title').value;
                const descriptionTextarea = document.getElementById('edit-item-desc');
                
                if (!title) {
                    alert("Nejprve zadejte název úkolu.");
                    return;
                }

                const originalButtonContent = button.innerHTML;
                button.innerHTML = '<div class="spinner-small border-2"></div>';
                button.disabled = true;

                const prompt = `Jsi expert na projektové řízení. Vylepši a rozšiř popis pro úkol s názvem "${title}". Původní popis je: "${descriptionTextarea.value}". Vytvoř jasný a stručný popis v rozsahu 1-2 vět. Odpověz pouze novým textem popisu.`;
                
                const newDescription = await callGemini(prompt);

                if (newDescription) {
                    descriptionTextarea.value = newDescription.trim();
                }
                
                button.innerHTML = originalButtonContent;
                button.disabled = false;
            }

            async function handleGenerateNewDescription(event) {
                const button = event.target.closest('button');
                const title = document.getElementById('item-title').value;
                const descriptionTextarea = document.getElementById('item-desc');
                
                if (!title) {
                    alert("Nejprve zadejte název úkolu.");
                    return;
                }

                const originalButtonContent = button.innerHTML;
                button.innerHTML = '<div class="spinner-small border-2"></div>';
                button.disabled = true;

                const prompt = `Jsi expert na projektové řízení. Vytvoř krátký, ale výstižný popis pro úkol s názvem "${title}". Popis by měl být v rozsahu 1-2 vět. Odpověz pouze novým textem popisu.`;
                
                const newDescription = await callGemini(prompt);

                if (newDescription) {
                    descriptionTextarea.value = newDescription.trim();
                }
                
                button.innerHTML = originalButtonContent;
                button.disabled = false;
            }

            // --- INICIALIZACE ---
                        const firebaseConfig = {
            apiKey: "AIzaSyC-FmJAtv9aNld-iHjtiwi2FVHjeDccT6w",
            authDomain: "sebit-web-timeline.firebaseapp.com",
            projectId: "sebit-web-timeline",
            storageBucket: "sebit-web-timeline.firebasestorage.app",
            messagingSenderId: "972665408352",
            appId: "1:972665408352:web:fc2eeb23ada54e2f76ec05"
            };
            initializeFirebase();
            window.addEventListener('resize', render);
        });
    </script>
</body>
</html>
